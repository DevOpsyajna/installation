---
- name: Install Chocolatey and Visual Studio Code on Windows
  hosts: 172.16.0.67
  gather_facts: no
  tasks:
    - name: Install Chocolatey
      win_command: |
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
      args:
        creates: C:\ProgramData\chocolatey\bin\choco.exe

    - name: Ensure chocolatey is in the PATH
      win_environment:
        state: present
        name: PATH
        value: C:\ProgramData\chocolatey\bin
        level: machine

    - name: Refresh environment variables to include Chocolatey
      win_command: powershell.exe -noprofile -command "[System.Environment]::SetEnvironmentVariable('Path', [System.Environment]::GetEnvironmentVariable('Path', 'Machine'), 'Process')"

    - name: Install Visual Studio Code using Chocolatey
      win_command: choco install vscode --yes --accept-license
